 <textarea autofocus rows="150" cols="150" wrap="soft" id="mathInput" spellcheck="false"></textarea>
<script type="text/javascript">
 	var textarea = document.getElementById("mathInput");
 	textarea.addEventListener("keydown", (e) => {

		console.log("Key " + e.keyCode + " pressed [event: keydown]");
		if(e.keyCode == 39){
			var pos = textarea.selectionStart + 1 ;
			textarea.setSelectionRange(pos, pos);
		}
		if(e.keyCode == 37){
			var pos = textarea.selectionStart - 1 ;
			textarea.setSelectionRange(pos, pos);
		}
		if(e.keyCode == 40){
			var pos = textarea.selectionStart;
			var txt = textarea.value;
			var lineStart = 0;
			var nextLineStart = txt.length;
			var nextLineEnd = txt.length;

			for (var i = pos - 1; i > 0; i--) { // najde začátek aktuální linky
				if(txt[i] == "\n"){
					lineStart = i+1;
					break;
				}
			}

			for (var i = pos; i < txt.length; i++) { // najde začátek další linky
				if(txt[i] == "\n"){
					nextLineStart = i+1;
					break;
				}
			}

			for (var i = nextLineStart; i < txt.length; i++) { // najde konec další linky
				if(txt[i] == "\n"){
					nextLineEnd = i+1;
					break;
				}
			}

			var fromLineStart = pos - lineStart
			var nvPos = nextLineStart + fromLineStart;
			var nextLineLen = nextLineEnd - nextLineStart;

			console.log(txt.slice(lineStart,nextLineStart));
			console.log(txt.slice(nextLineStart,nextLineEnd));
			console.log(txt.slice(nextLineStart,nvPos));

			if(fromLineStart >= nextLineLen){
				if(nextLineEnd == txt.length){
					textarea.setSelectionRange(nextLineEnd, nextLineEnd);
				}else{
					textarea.setSelectionRange(nextLineEnd-1, nextLineEnd-1);
				}

				console.log("next line too short");
				//return 1;
			}else{
				if(nextLineStart != nextLineEnd){
					textarea.setSelectionRange(nvPos, nvPos);
					console.log("normal jump");
					//return 1;
				}
			}
		}



		if(e.keyCode == 38){
			var pos = textarea.selectionStart;
			var txt = textarea.value;

			var len = 0;
			var lineStart = 0;
			var pastLineStart = 0;

			for (var i = pos - 1; i > 0; i--) {
				if(txt[i] == "\n"){
					lineStart = i+1;
					break;
				}
			}

			for (var i = lineStart-2; i > 0; i--) {
				if(txt[i] == "\n"){
					pastLineStart = i+1;
					break;
				}
			}


			var fromLineStart = pos - lineStart
			var nvPos = pastLineStart + fromLineStart;
			var nextLineLen = lineStart - pastLineStart;

			console.log(txt.slice(pastLineStart,lineStart-1));
			console.log(txt.slice(lineStart,lineStart+5));

			console.log(fromLineStart,nextLineLen-1);

			//textarea.setSelectionRange(nvPos, nvPos);

            
			if(fromLineStart > nextLineLen-1){
				textarea.setSelectionRange(lineStart-1, lineStart-1);
				console.log("next line too short");
				//return 1;
			}else{
				//if(pastLineStart != lineStart-1){
					textarea.setSelectionRange(nvPos, nvPos);
					console.log("normal jump");
					//return 1;
				//}
			}
		}





		if(e.keyCode >= 37 && e.keyCode <= 40){
			e.preventDefault();
			e.stopImmediatePropagation();
			return false;

		}	
	});	

 </script>